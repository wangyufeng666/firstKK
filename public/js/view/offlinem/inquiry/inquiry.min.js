var totle_length = 0;
var select_length = 0;

$('.card').click(function(){
    var par_type = $(this).parents('.stepItem').attr('data-type');
    totle_length = $('.stepItem[data-type=R]').length;
    if(par_type == 'R'){
        
        $(this).addClass('selected').siblings().removeClass('selected');
        var _this = $(this);
        setTimeout(function(){
            
            _this.parents('.stepItem').addClass('selected').removeClass('actived');
            
            select_length = $('.stepItem[data-type=R].selected').length;
            //进度条处理
            var bar_percent = parseInt(select_length/totle_length*100);
            $('.inner_bar').html(bar_percent+'%');
            $('.bar_box').removeClass('hide');
            $('.inquery_mername').addClass('scroller');
            
            $('.inner_bar').css('width',bar_percent+'%');
            if(bar_percent == '100'){
                $('.inner_bar').css('border-radius', '0 0 0 0');            
            }
            
            if(select_length == totle_length){ //显示立即回收
                $('.nextstep').addClass('recycle');
            }
            if( _this.parents('.stepItem').attr('data-type') == 'R'){
                _this.parents('.stepItem').find('.selected_text').text(_this.attr('title'));
            }
            var next_type = _this.parents('.stepItem').next().attr('data-type');
            if(next_type == 'R'){
                var showFlage = true,scrollTopIndex = 0;
                $('.stepItems .stepItem').each(function(){ //显示下一个没有选择的
                    if(showFlage){
                        scrollTopIndex++;
                        if($(this).attr('data-type') == 'R'){
                            if(!$(this).hasClass('selected')){
                                $(this).addClass('actived');
                                showFlage = false;
                                $('html,body').animate({scrollTop:($('.stepItems .stepItem .title').outerHeight())*(scrollTopIndex-1)}, 300);
                            }
                        }
                    }
                });
            }else{
                $('.stepItem[data-type=C]').addClass('actived');
            }
        },300)
        
    }else{
        if($(this).hasClass('selected')){
            $(this).removeClass('selected');
        }else{
            $(this).addClass('selected');
        }
    }
})

//点击修改按钮
$('.modify').click(function(){
    $('.stepItem[data-type=R]').removeClass('actived');
    $(this).parents('.stepItem').addClass('actived');
})

//点击图片
$('.card img').click(function(e){
    e.stopPropagation();
    var _thisPath = $(this).attr('src');
    var _thisText = $(this).attr('title');
    showImg(_thisPath,_thisText);
})

//关闭弹窗
$('.close_img').click(function(){
    $('.img_slide,.pop_slide').hide();
})

//去询价
$('#btn_submit').click(function(){
    if(!$(this).hasClass('recycle')){
        var _thisTitle = $('.stepItem').eq(select_length).find('.text').attr('title');
        short_tips('请选择'+_thisTitle);
        return;
    }else{
        var rIds = [];
        var cIds = [];
        $('.stepItem').each(function(){
            if($(this).attr('data-type') == 'R'){
                var _thisId = $(this).find('.cards .selected').attr('id')
                rIds.push(_thisId);
            }else{
                $('.cards .card.selected',$(this)).each(function(){
                    cIds.push($(this).attr('id'));
                });
            }
        });
        $('#radioIds').val(rIds.join('#'));
        $('#multiIds').val(cIds.join('#'));
        tobubmit();
    }
})

//去询价
function tobubmit(){
    $('#addForm').submit();
}

//取消输入验证码
$('.login_code').delegate('.code_cancel','click',function(){
    $('.login_code').addClass('hide');
    $('.getsimcode').removeClass('disabled');
})

//图片验证码是否正确
$('.login_code').delegate('.code_yes','click',function(){
    var imgcodeVal = $('#imgcode').val();
    if(imgcodeVal == ''){
        layerTips('验证码不能为空','imgcode');
    }else if(imgcodeVal.length != 4){
        layerTips('验证码为4位','imgcode');
    }else{
        $.post('/common/securitycode/verifynum',{flag:'inquiry',code:imgcodeVal},function(data){
            if(data){
                $('.login_code').hide();
                tobubmit();
            }else{
                layerTips('请输入正确的验证码','imgcode');
            }
        })
    }
})

function layerTips(text,id){
    layer.tips(text,'#'+id,{
        tips: 3
    });
}