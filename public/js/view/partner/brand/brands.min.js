var leftScroll, rightScroll, pullUpEl, pullUpOffset, generatedCount = 0;
function pullUpAction(){
	var el, li, i, a;
	el = document.getElementById('mersUl');
	if(!params.loading){
		if(params.pageNo >= params.totalPage){
			layer.msg('加载完毕');
		}else{
			params.loading = true;
			params.pageNo = params.pageNo+1;
			var href = '#';
			$.post('/offlinem/product/jsonlist',{mertype:params.merType, pcode:params.pcode, pageNo:params.pageNo},function(data){
				params.totalPage = parseInt(data['totalPage'], 10);
				var list = data['result'];
				for(i=0; i<list.length;i++){
					li = document.createElement('li');
					li.innerText = list[i].MERNAME;
					document.createElement('li');
					a = document.createElement('a');
					href = '/offlinem/inquiry/init?spid='+list[i].MERID;
					a.setAttribute("href",href);
					a.appendChild(li);
					el.appendChild(a, el.childNodes[0]);
				}
				params.loading = false;
				rightScroll.refresh();
			});
		}
	}
}
function loaded(){
	pullUpEl = document.getElementById('pullUp'); 
	pullUpOffset = pullUpEl.offsetHeight;
	leftScroll = new IScroll('#brandWrapper',{mouseWheel:false,click:true});
	rightScroll = new IScroll('#mersWrapper',{mouseWheel:false,click:true});
	
	rightScroll.on('scrollEnd', function(){
		if(pullUpEl.className.match('flip')){
			if(params.pageNo < params.totalPage){
				pullUpEl.className = 'loading';
				$('#pullUp').show();
				$('#pullUp .pullUpLabel').html('数据加载中...');
				pullUpAction();
			}
		}
	});
	rightScroll.on('scrollMove', function(){
		if(this.y < (this.maxScrollY - 50) && !pullUpEl.className.match('flip')) {
			pullUpEl.className = 'flip';
			if(params.pageNo < params.totalPage){
				$('#pullUp').show();
				$('#pullUp .pullUpLabel').html('释放加载');
			}else{
				$('#pullUp .pullUpLabel').empty();
				$('#pullUp').hide();
			}
        }else if (this.y > (this.maxScrollY + 50) && pullUpEl.className.match('flip')) {
        	pullUpEl.className = '';
			if(params.pageNo < params.totalPage){
				$('#pullUp').show();
				$('#pullUp .pullUpLabel').html('上拉加载更多');
			}else{
				$('#pullUp .pullUpLabel').empty();
				$('#pullUp').hide();
			}
        }
	});
	rightScroll.on('refresh', function(){
		if (pullUpEl.className.match('loading')) {
			pullUpEl.className = '';
			if(params.pageNo < params.totalPage){
				$('#pullUp').show();
				$('#pullUp .pullUpLabel').html('上拉加载更多');
			}else{
				$('#pullUp').hide();
				$('#pullUp .pullUpLabel').empty();
			}
		}
	});
	leftScroll.scrollToElement(document.querySelector('#brandScroller li:nth-child('+checkIndex+')'), null, null, true);
}

//document.addEventListener('touchmove', function(e){e.preventDefault();}, false);
document.addEventListener('DOMContentLoaded', loaded, false);

var t1 = null;
$().ready(function(){
	$('#brandWrapper li').click(function(e){
		e.preventDefault();
		if (t1 == null){
			t1 = new Date().getTime();
		}else{
			var t2 = new Date().getTime();
			if(t2 - t1 < 500){
				t1 = t2;
				return;
			}else{
				t1 = t2;
			}
		}
		var brandCode = $(this).attr('data-id');
		$('#brandScroller li').removeClass('current');
		$(this).addClass('current');
		if(params.pcode != brandCode){
			$('#pullUp').show();
			$('#pullUp .pullUpLabel').html('数据加载中...');
			var el, li, i, a;
			$('#mersUl').empty();
			el = document.getElementById('mersUl');
			$.post('/offlinem/product/jsonlist',{mertype:params.merType, pcode:brandCode, pageNo:1},function(data){
				params.pageNo = 1;
				params.pcode = brandCode;
				params.totalPage = parseInt(data['totalPage'], 10);
				if(params.totalPage <= 1){
					$('#pullUp').hide();
					$('#pullUp .pullUpLabel').empty();
				}else{
					$('#pullUp').show();
					$('#pullUp .pullUpLabel').html('上拉加载更多');
				}
				var list = data['result'];
				for(i=0; i<list.length;i++){
					li = document.createElement('li');
					li.innerText = list[i].MERNAME;
					document.createElement('li');
					a = document.createElement('a');
					href = '/offlinem/inquiry/init?spid='+list[i].MERID;
					a.setAttribute("href",href);
					a.appendChild(li);
					el.appendChild(a, el.childNodes[0]);
				}
				rightScroll.refresh();
				rightScroll.scrollToElement(document.querySelector('#brandScroller li:nth-child(1)'), null, null, true);
			});
		}
	});
	
	$('#searchBtn').click(function(){
		window.location.href = '/offlinem/product/searchindex?mertype='+params.merType;
	});
});