var mersScroll, pullUpEl, pullUpOffset, generatedCount = 0;

$().ready(function(){
	$('#moreMerTypes li[data-id="'+params.merType+'"]').addClass('hide');
});

$('#moreMerTypes li').click(function(){
	params.merType = $(this).attr('data-id');
	$('#searchTypeText').html($(this).html()+'<i></i>');
	$('#moreMerTypes li').removeClass('hide');
	$(this).addClass('hide');
	$('#moreTypeWrap').toggle();
	params.pcode = '';
	doSearch();
});
var t1 = null;
$('#searchTypeText').click(function(){
	if (t1 == null){
        t1 = new Date().getTime();
    }else{       
        var t2 = new Date().getTime();
        if(t2 - t1 < 500){
            t1 = t2;
            return;
        }else{
            t1 = t2;
        }
    }
	$('#moreTypeWrap').toggle();
});

function pullUpAction(){
	var el, li, i, a;
	el = document.getElementById('mersUl');
	if(!params.loading){
		if(params.pageNo >= params.totalPage){
			layer.msg('加载完毕');
		}else{
			params.loading = true;
			params.pageNo = params.pageNo+1;
			var href = '#';
			$.post('/offlinem/product/jsonlist',{mertype:params.merType, pcode:params.pcode, pageNo:params.pageNo},function(data){
				params.totalPage = parseInt(data['totalPage'], 10);
				var list = data['result'];
				for(i=0; i<list.length;i++){
					li = document.createElement('li');
					li.innerText = list[i].MERNAME;
					document.createElement('li');
					a = document.createElement('a');
					href = '/offlinem/inquiry/init?spid='+list[i].MERID;
					a.setAttribute("href",href);
					a.appendChild(li);
					el.appendChild(a, el.childNodes[0]);
				}
				params.loading = false;
				mersScroll.refresh();
			});
		}
	}
}

function loaded(){
	pullUpEl = document.getElementById('pullUp'); 
	pullUpOffset = pullUpEl.offsetHeight;
	mersScroll = new IScroll('#mersWrapper',{mouseWheel:false,click:true});
	mersScroll.on('scrollEnd', function(){
		if(params.totalPage > 0){
			if(pullUpEl.className.match('flip')){
				if(params.pageNo < params.totalPage){
					pullUpEl.className = 'loading';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '数据加载中，请稍后';        
					pullUpAction();
				}
			}
		}
	});
	mersScroll.on('scrollMove', function(){
		if(params.totalPage > 0){
			if (this.y < (this.maxScrollY - 50) && !pullUpEl.className.match('flip')) {
				pullUpEl.className = 'flip';
				if(params.pageNo < params.totalPage){
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '释放加载';
				}else{
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '没有更多';
				}
	        } else if (this.y > (this.maxScrollY + 50) && pullUpEl.className.match('flip')) {
	        	pullUpEl.className = '';
				if(params.pageNo < params.totalPage){
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多商品';
				}else{
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '没有更多';
				}
	        }
		}
	});
	mersScroll.on('refresh', function(){
		if(params.totalPage > 0){
			if (pullUpEl.className.match('loading')) {
				pullUpEl.className = '';
				if(params.pageNo < params.totalPage){
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多商品';
				}else{
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '没有更多';
				}
			}
		}
	});
}
//document.addEventListener('touchmove', function(e){e.preventDefault();}, false);
document.addEventListener('DOMContentLoaded', loaded, false);
//文本框查询
function doSearch(){
	location.href = '/offlinem/product/searchindex?mertype='+params.merType+'&pcode='+params.pcode;
}

$('#searchBar').click(function(){
	if (t1 == null){
        t1 = new Date().getTime();
    }else{       
        var t2 = new Date().getTime();
        if(t2 - t1 < 500){
            t1 = t2;
            return;
        }else{
            t1 = t2;
        }
    }
	doSearch();
});
function merInquiry(merId){
	window.location.href = '/offlinem/inquiry/init?spid='+merId;
}