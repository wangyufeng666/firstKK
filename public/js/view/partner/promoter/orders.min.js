var unLoading = true;
function scrollEvent(){
	// 当滚动到最底部以上10像素时， 加载新内容
	var height = $(document).scrollTop() + $(window).height()-$(document).height();
	if (height > -10 && unLoading){
		unLoading = false;
		$(window).unbind('scroll');
		$('#orderlist').append('<li id="loading" style="display:none;" class="item ydm-tc">正在加载中，请稍后...</li>');
		$('#loading').fadeIn('slow', function(){
			var pageNo = parseInt($('#pageNo').val(), 10)+1;
			var totalPage = parseInt($('#totalPage').val(), 10);
			
			if(pageNo > totalPage){
				$('#loading').fadeOut('slow', function(){
					$('#loading').remove();
				});
			}else{
				$('#pageNo').val(pageNo);
				var html = '';
				var partnerCode = $('#partnerCode').val();
				var promoCode = $('#promoCode').val();
				var pageNo = $('#pageNo').val();
				$.ajax({
					type:'GET',
					dataType:'json',
					cache:false,
					async:false,
					url:'/partner/promoter/jsonorders',
					data:{partnerCode:partnerCode, pageNo:pageNo, promoCode:promoCode},
					success:function(data){
						var list = data['result'];
						for(var i = 0; i < list.length; i++){
							html +='<div class="li"><li>';
							html +='<div class="orderInfo" orderNo='+list[i].ORDERNO+'>';
								html +='<div class="oitop">';
									html +='<span class="orderno">订单编号：'+list[i].ORDERNO+'</span><span class="orderstatus">'+list[i].STATUSNAME+'</span>';
								html +='</div>';
							html +=' <div class="oibody">';
								html +='<div class="img"><img src="http://images.youdemai.com/nwimages/images/thumbs'+list[i].MERIMG+'"/></div>';
								html +='<div class="mername"><div class="name">'+list[i].MERNAME+'</div><div class="datetime">'+list[i].ORDERDATE+'</div>';
								html +='<div class="price">回收价格：￥'+list[i].ORDERPRICE+'</div>';
								if(list[i].CREDITFLAG && list[i].CREDITMONEY > 0){
									html +='<div class="orice">先行支付金额：￥'+list[i].CREDITMONEY+'</div>';	
								}
							html +='</div>';
							html +='</div>';
							html +='<div class="bottom clearfix">';
							if(list[i].CREDITFLAG && list[i].CREDITMONEY > 0){
								html +='<div><span class="text">信用回收订单</span><div>';
							}else{
								html +='<div><span class="text">普通订单</span></div>';
							}
							html +='</div></li></div>';
						}
						$("#loading").fadeOut("slow", function(){
							$('#loading').remove();
							$('#orderlist').append(html);
						});
						setTimeout(function(){$(window).bind('scroll', function(){scrollEvent();unLoading = true;});}, 1000);
					}
				});
			}
		});
	}
}


var t1 = null;
function loaded(){
	$("#leftGoBack").on("click",function(e){
		e.preventDefault();
		if (t1 == null){
			t1 = new Date().getTime();
		}else{
			var t2 = new Date().getTime();
			if(t2 - t1 < 500){
				t1 = t2;
				return;
			}else{
				t1 = t2;
			}
		}
		window.history.back();
	});
}

$("#orderlist").delegate('.orderInfo','click',function(){
	var orderNo = $(this).attr('orderNo');
	window.location.href = '/partner/promoter/order?orderNo='+orderNo;
})

$().ready(function(){
	$(window).bind('scroll', function(){scrollEvent();});
	
	  var clientHeight = document.documentElement.clientHeight;
	  var headerHeight = 0;
	  var bottomHeight = 0;
	  if($('.header')){
	    headerHeight = $('.header').height();
	  }
	  if($('.btmmenu')){
	    bottomHeight = $('.btmmenu').height();
	  }
	$('#ordersArea').css({'min-height':(clientHeight-headerHeight-bottomHeight)+'px'});
    $('#navShow').click(function(e){
	  	if(e && e.stopPropagation){//非IE
	          e.stopPropagation();
	      }else {//IE
	          window.event.cancelBubble = true;
	      }
	  	if (t1 == null){
	  		t1 = new Date().getTime();
	  	}else{
	  		var t2 = new Date().getTime();
	  		if(t2 - t1 < 500){
	  			t1 = t2;
	  			return;
	  		}else{
	  			t1 = t2;
	  		}
  	  }
      document.getElementById("nav").className="nav_show";
      document.onclick = function(){
          document.getElementById("nav").className="hidden";
          document.onclick=null;
      };
    });
    $('#order_homeMenu').click(function(e){
	  	if(e && e.stopPropagation){//非IE
	          e.stopPropagation();
	      }else {//IE
	          window.event.cancelBubble = true;
	      }
	  	if (t1 == null){
	  		t1 = new Date().getTime();
	  	}else{
	  		var t2 = new Date().getTime();
	  		if(t2 - t1 < 500){
	  			t1 = t2;
	  			return;
	  		}else{
	  			t1 = t2;
	  		}
	  	}
	  	top.location.href = '/offlinem';
    });

    $('#order_ordersMenu').click(function(e){
	  	if(e && e.stopPropagation){//非IE
	          e.stopPropagation();
	      }else {//IE
	          window.event.cancelBubble = true;
	      }
	  	if (t1 == null){
	  		t1 = new Date().getTime();
	  	}else{
	  		var t2 = new Date().getTime();
	  		if(t2 - t1 < 500){
	  			t1 = t2;
	  			return;
	  		}else{
	  			t1 = t2;
	  		}
	  	}
	      window.location.href = '/offlinem/trade/index';
    });
});